version: 2
jobs:
  build:
    docker:
      - image: yeongsheng/alpine-elixir-circleci:latest
    environment:
      - MIX_ENV: test
      - BASH_ENV: ~/.env
      # - WORKING_DIRECTORY: ~/hello_phoenix
    working_directory: echo "~/$WORKING_DIRECTORY"
    steps:
      - run: echo $HOME

      - checkout

      - run:
          command: /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
          background: true

      - restore_cache:
          keys:
            - v1-myapp-deps-{{ checksum "mix.exs" }}
            - v1-myapp-deps-

      - run: mix deps.get

      - save_cache:
          key: v1-myapp-deps-{{ checksum "mix.exs" }}
          paths:
            # - echo "~/$WORKING_DIRECTORY/deps"
            - ~/$(eval echo ${WORKING_DIRECTORY})/deps

      - restore_cache:
          keys:
            - v1-myapp-build-{{ checksum "mix.exs" }}
            - v1-myapp-build-

      - run: mix deps.compile

      - save_cache:
          key: v1-myapp-build-{{ checksum "mix.exs" }}
          paths:
            # - echo "~/$WORKING_DIRECTORY/_build"
            - ~/$(eval echo ${WORKING_DIRECTORY})/_build

      - run: mix ecto.create

      - run: mix ecto.migrate

      - run: mix espec

# machine:
  # environment:
  #   PATH: "$HOME/.asdf/bin:$HOME/.asdf/shims:$PATH"
#     MIX_ENV: test
#
# dependencies:
#   pre:
#     - if ! asdf | grep version; then git clone https://github.com/asdf-vm/asdf.git ~/.asdf; fi
#     - asdf plugin-add erlang https://github.com/asdf-vm/asdf-erlang.git || true
#     - asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git || true
#     - asdf install
#     - mix local.hex --force
#     - mix local.rebar --force
#   override:
#     - mix deps.get
#   cache_directories:
#     - ~/.asdf
#     - ~/.mix
#     - deps
#     - _build
#
# test:
#   override:
#     - mix ecto.create
#     - mix ecto.migrate
#     - mix espec
